<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Library Modern System</title>
    <!-- Menggunakan Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1521587760476-6c12a4b040da?auto=format&fit=crop&w=2000&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .page {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .page.hidden {
            display: none;
            opacity: 0;
            transform: scale(0.95);
        }
        .fade-in {
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .book-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .book-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
        }
        .form-container {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            background-color: rgba(255, 255, 255, 0.92);
        }
        .text-shadow-lg {
            text-shadow: 0 4px 6px rgba(0,0,0,0.6);
        }
        
        /* Styling untuk Modal */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal.hidden {
            display: none;
            opacity: 0;
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }

        /* Custom Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        .toast {
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
        }
        .toast.show {
            transform: translateX(0);
        }

        /* Star Rating Styling */
        .star-rating input {
            display: none;
        }
        .star-rating label {
            cursor: pointer;
            width: 25px;
            font-size: 25px;
            color: #ccc;
            float: right; /* Right to left for CSS sibling selector logic */
            transition: color 0.2s;
        }
        /* Ketika label dihover atau input dicek, ubah warna */
        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #fbbf24; /* Amber-400 */
        }
    </style>
</head>
<body class="text-gray-800 antialiased">

    <!-- Latar Belakang Overlay -->
    <div class="fixed inset-0 bg-black/60 z-[-1]"></div>

    <!-- Toast Container -->
    <div id="toast-container" class="flex flex-col gap-2"></div>

    <!-- Custom Confirm Modal -->
    <div id="custom-confirm-modal" class="modal hidden fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full relative z-10 transform transition-all scale-100">
            <div class="flex items-center gap-3 mb-4 text-amber-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <h3 class="text-lg font-bold text-gray-900">Konfirmasi</h3>
            </div>
            <p id="confirm-message" class="text-gray-600 mb-6">Apakah Anda yakin?</p>
            <div class="flex justify-end gap-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-medium transition">Batal</button>
                <button id="confirm-yes-btn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-bold shadow transition">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- Kontainer Utama Aplikasi -->
    <div id="app" class="min-h-screen flex items-center justify-center p-4">

        <!-- 1. Halaman Login -->
        <div id="login-page" class="page w-full max-w-md fade-in">
            <div class="form-container shadow-2xl rounded-2xl p-8 border border-white/20">
                <div class="flex justify-center mb-6">
                    <div class="bg-indigo-100 p-3 rounded-full shadow-inner">
                        <svg class="w-10 h-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25a8.987 8.987 0 016 0v-1.75a8.967 8.967 0 01-3-.512V6.042zM18 17.25a8.967 8.967 0 00-6-2.292m6 2.292c1.052 0 2.062.18 3 .512v-14.25a8.987 8.987 0 00-6 0v1.75a8.967 8.967 0 003-.512v11.25z" />
                        </svg>
                    </div>
                </div>
                <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-2">E-Library</h1>
                <p class="text-center text-gray-500 mb-8 text-sm">Masuk untuk mengakses ribuan buku.</p>
                
                <div id="login-error-message" class="hidden bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-6 text-sm shadow-sm" role="alert">
                    <p>Username atau password salah.</p>
                </div>
                <div id="login-success-message" class="hidden bg-green-50 border-l-4 border-green-500 text-green-700 p-4 rounded-md mb-6 text-sm shadow-sm" role="alert">
                    <p>Registrasi berhasil! Silakan tunggu persetujuan admin.</p>
                </div>

                <form id="login-form" class="space-y-5">
                    <div>
                        <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                        <input type="text" id="username" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition duration-200" placeholder="Contoh: user123" required>
                    </div>
                    <div>
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="password" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition duration-200" placeholder="••••••••" required>
                    </div>
                    <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300 transform hover:-translate-y-0.5" type="submit">
                        Masuk Sekarang
                    </button>
                </form>
                
                <div class="mt-8 text-center border-t border-gray-200 pt-6">
                    <p class="text-sm text-gray-600">Belum punya akun? <a href="#" id="show-register-link" class="font-semibold text-indigo-600 hover:text-indigo-800 transition">Daftar di sini</a></p>
                </div>
                
                <div class="mt-6 text-xs text-center text-gray-500 bg-gray-50 border border-gray-200 p-3 rounded-lg">
                    <p class="font-semibold mb-1">Akun Demo:</p>
                    <p>Super Admin: <b>denian</b> / <b>prasetya</b></p>
                    <p>User: <b>user123</b> / <b>user123</b></p>
                </div>
            </div>
        </div>

        <!-- 2. Halaman Registrasi -->
        <div id="register-page" class="page hidden w-full max-w-md">
            <div class="form-container shadow-2xl rounded-2xl p-8 border border-white/20">
                <div class="flex justify-center mb-6">
                    <div class="bg-indigo-100 p-3 rounded-full shadow-inner">
                        <svg class="w-10 h-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 019.374 21c-2.331 0-4.512-.645-6.374-1.766z" />
                        </svg>
                    </div>
                </div>
                <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">Buat Akun Baru</h1>
                <p class="text-center text-gray-500 mb-6 text-sm">Bergabunglah dengan komunitas pembaca kami.</p>
                
                <div id="register-error-message" class="hidden bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-4 text-sm" role="alert"></div>
                
                <form id="register-form" class="space-y-5">
                    <div>
                        <label for="reg-username" class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                        <input type="text" id="reg-username" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition duration-200" required>
                    </div>
                    <div>
                        <label for="reg-password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="reg-password" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition duration-200" required>
                    </div>
                    <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transition duration-300 transform hover:-translate-y-0.5" type="submit">
                        Daftar
                    </button>
                </form>
                <div class="mt-8 text-center border-t border-gray-200 pt-6">
                    <p class="text-sm text-gray-600">Sudah punya akun? <a href="#" id="show-login-link" class="font-semibold text-indigo-600 hover:text-indigo-800 transition">Login di sini</a></p>
                </div>
            </div>
        </div>

        <!-- 3. Halaman Library -->
        <div id="library-page" class="page hidden w-full max-w-7xl mx-auto pb-10">
            <header class="bg-white/90 backdrop-blur-md shadow-lg rounded-2xl p-4 mb-8 flex flex-wrap justify-between items-center gap-4 sticky top-4 z-30 border border-white/20 ring-1 ring-black/5">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-2 rounded-lg shadow-md">
                        <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25a8.987 8.987 0 016 0v-1.75a8.967 8.967 0 01-3-.512V6.042zM18 17.25a8.967 8.967 0 00-6-2.292m6 2.292c1.052 0 2.062.18 3 .512v-14.25a8.987 8.987 0 00-6 0v1.75a8.967 8.967 0 003-.512v11.25z" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800 tracking-tight">E-Library</h1>
                        <p id="welcome-message" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded inline-block mt-1 border border-indigo-100"></p>
                    </div>
                </div>
                <button id="logout-btn" class="flex items-center gap-2 bg-white text-red-600 hover:bg-red-50 hover:text-red-700 font-semibold py-2 px-5 rounded-xl transition-all duration-300 border border-red-100 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
                    </svg>
                    Logout
                </button>
            </header>

            <!-- Panel untuk Admin & Super Admin -->
            <div id="admin-panel" class="hidden fade-in space-y-8">
                <!-- Section 1: Pantauan Ulasan (Fitur Baru) -->
                <div class="bg-white/95 backdrop-blur shadow-xl rounded-2xl p-6 border border-white/40">
                     <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                        <span class="bg-yellow-100 p-1.5 rounded-lg text-yellow-600">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                              <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        Pantauan Ulasan Terbaru
                    </h2>
                    <div id="recent-reviews-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-60 overflow-y-auto custom-scroll pr-2">
                        <!-- List ulasan terbaru akan dirender di sini -->
                        <p class="text-gray-400 text-sm italic col-span-full text-center py-4">Belum ada ulasan masuk.</p>
                    </div>
                </div>

                <!-- Section 2: Tambah Buku -->
                <div class="bg-white/95 backdrop-blur shadow-xl rounded-2xl p-6 border border-white/40">
                    <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center gap-2">
                        <span class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </span>
                        Panel Admin: Tambah Buku Baru
                    </h2>
                    <form id="add-book-form">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="new-book-title" class="block text-sm font-semibold text-gray-700 mb-1">Judul Buku</label>
                                <input type="text" id="new-book-title" class="w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Judul buku..." required>
                            </div>
                            <div>
                                <label for="new-book-author" class="block text-sm font-semibold text-gray-700 mb-1">Penulis</label>
                                <input type="text" id="new-book-author" class="w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Nama penulis..." required>
                            </div>
                            <div>
                                <label for="new-book-cover" class="block text-sm font-semibold text-gray-700 mb-1">URL Gambar Cover</label>
                                <input type="url" id="new-book-cover" class="w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="https://..." required>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="new-book-content" class="block text-sm font-semibold text-gray-700 mb-1">Sinopsis / Isi Buku</label>
                            <textarea id="new-book-content" rows="3" class="w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Tulis ringkasan atau isi buku di sini..."></textarea>
                        </div>
                        <div class="mt-6 text-right">
                            <button type="submit" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-6 rounded-lg transition-all transform hover:scale-105 shadow-md flex items-center justify-center gap-2 ml-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                                Tambah Buku
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Panel KHUSUS Super Admin -->
            <div id="superadmin-panel" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 mt-8 fade-in">
                <div class="bg-white/95 shadow-xl rounded-2xl p-6 border border-white/40 flex flex-col">
                    <h2 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2 flex justify-between items-center">
                        Persetujuan Anggota Baru
                        <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full" id="approval-count">0</span>
                    </h2>
                    <div id="approval-list" class="space-y-3 overflow-y-auto max-h-64 custom-scroll pr-2 flex-1">
                        <!-- List persetujuan akan dirender di sini -->
                    </div>
                </div>

                <div class="bg-white/95 shadow-xl rounded-2xl p-6 border border-white/40 flex flex-col">
                    <h2 class="text-lg font-bold mb-4 text-gray-800 border-b pb-2">Kelola Pengguna</h2>
                    <div id="user-management-list" class="space-y-3 overflow-y-auto max-h-64 custom-scroll pr-2 flex-1">
                        <!-- List pengguna akan dirender di sini -->
                    </div>
                </div>
            </div>

            <main class="fade-in delay-100 mt-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-white text-shadow-lg tracking-tight">Koleksi Buku</h2>
                    <span class="bg-black/30 backdrop-blur px-4 py-1.5 rounded-full text-white text-sm border border-white/20 font-medium shadow-lg">
                        Total: <span id="total-books-count" class="font-bold text-indigo-200">0</span> Buku
                    </span>
                </div>
                
                <div id="book-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                    <!-- Kartu buku akan dirender di sini -->
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Detail Buku, Baca & Ulasan -->
    <div id="read-book-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" id="close-read-overlay"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col relative z-10 transform transition-all scale-100 overflow-hidden">
            <!-- Header Modal -->
            <div class="flex justify-between items-start p-6 border-b bg-gray-50">
                <div>
                    <h3 id="read-book-title" class="text-2xl font-bold text-gray-900 font-serif">Judul Buku</h3>
                    <div class="flex items-center gap-2 mt-1">
                        <p class="text-sm text-gray-500">Detail & Ulasan</p>
                        <span class="text-gray-300">|</span>
                        <div id="modal-avg-rating" class="text-amber-500 text-sm font-bold flex items-center"></div>
                    </div>
                </div>
                <button id="close-read-modal" class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Content Modal (Grid 2 Kolom di Desktop) -->
            <div class="flex-1 overflow-y-auto custom-scroll bg-[#fffdf8] p-0">
                <div class="grid grid-cols-1 md:grid-cols-2 min-h-full divide-y md:divide-y-0 md:divide-x divide-gray-200">
                    
                    <!-- Kolom Kiri: Sinopsis -->
                    <div class="p-8">
                        <h4 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 border-gray-200">Sinopsis / Isi</h4>
                        <div id="read-book-content" class="leading-relaxed text-gray-800 text-lg font-serif text-justify">
                            <p>Isi buku...</p>
                        </div>
                    </div>

                    <!-- Kolom Kanan: Ulasan & Rating -->
                    <div class="p-8 bg-gray-50/50">
                        <h4 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 border-gray-200 flex justify-between items-center">
                            Ulasan Pembaca
                            <span id="review-count-badge" class="bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full">0</span>
                        </h4>
                        
                        <!-- Form Tambah Ulasan (Hanya muncul jika User login) -->
                        <div id="add-review-section" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6">
                            <h5 class="text-sm font-bold text-gray-700 mb-2">Berikan Rating Anda</h5>
                            <form id="review-form">
                                <input type="hidden" id="review-book-id">
                                <div class="flex flex-row-reverse justify-end gap-1 star-rating mb-3">
                                    <input type="radio" id="star5" name="rating" value="5"><label for="star5" title="Sempurna">★</label>
                                    <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="Bagus">★</label>
                                    <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="Oke">★</label>
                                    <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="Buruk">★</label>
                                    <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="Sangat Buruk">★</label>
                                </div>
                                <textarea id="review-comment" rows="3" class="w-full text-sm border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500 mb-2" placeholder="Bagaimana pendapatmu tentang buku ini?" required></textarea>
                                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 rounded-lg transition">Kirim Ulasan</button>
                            </form>
                        </div>

                        <!-- List Ulasan -->
                        <div id="reviews-list" class="space-y-4">
                            <!-- Ulasan akan dirender di sini -->
                            <p class="text-center text-gray-400 text-sm italic mt-4">Belum ada ulasan. Jadilah yang pertama!</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button class="text-sm font-medium text-gray-600 hover:text-gray-900 px-4 py-2 rounded-lg hover:bg-gray-200 transition" onclick="document.getElementById('read-book-modal').classList.add('hidden')">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal untuk Mengedit Buku -->
    <div id="edit-book-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" id="close-edit-overlay"></div>
        <form id="edit-book-form" class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col relative z-10 overflow-hidden">
            <input type="hidden" id="edit-book-id">
            <div class="flex justify-between items-center p-6 border-b bg-gray-50">
                <h3 class="text-xl font-bold text-gray-800">Edit Data Buku</h3>
                <button id="close-edit-modal" type="button" class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-full transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll space-y-5">
                <div>
                    <label for="edit-book-title" class="block text-sm font-medium text-gray-700 mb-1">Judul</label>
                    <input type="text" id="edit-book-title" class="w-full border border-gray-300 rounded-lg py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 transition" required>
                </div>
                <div>
                    <label for="edit-book-author" class="block text-sm font-medium text-gray-700 mb-1">Penulis</label>
                    <input type="text" id="edit-book-author" class="w-full border border-gray-300 rounded-lg py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 transition" required>
                </div>
                <div>
                    <label for="edit-book-cover" class="block text-sm font-medium text-gray-700 mb-1">URL Cover</label>
                    <input type="url" id="edit-book-cover" class="w-full border border-gray-300 rounded-lg py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 transition" required>
                </div>
                <div>
                    <label for="edit-book-content" class="block text-sm font-medium text-gray-700 mb-1">Isi Buku</label>
                    <textarea id="edit-book-content" rows="6" class="w-full border border-gray-300 rounded-lg py-2 px-3 focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                </div>
            </div>
            <div class="p-5 border-t bg-gray-50 text-right flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('edit-book-modal').classList.add('hidden')" class="px-4 py-2 text-gray-600 font-medium hover:bg-gray-200 rounded-lg transition">Batal</button>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow transition-transform transform hover:scale-105">Simpan Perubahan</button>
            </div>
        </form>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- UTILS: UI HELPERS ---
        
        const showToast = (message, type = 'success') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-gray-800');
            
            toast.className = `toast px-6 py-4 rounded-xl shadow-2xl text-white flex items-center gap-3 ${bgColor} min-w-[300px] z-50`;
            toast.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    ${type === 'success' 
                        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />' 
                        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'}
                </svg>
                <span class="font-medium text-sm">${message}</span>
            `;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        const customConfirm = (message, onConfirm) => {
            const modal = document.getElementById('custom-confirm-modal');
            const msgEl = document.getElementById('confirm-message');
            const yesBtn = document.getElementById('confirm-yes-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');
            
            msgEl.textContent = message;
            modal.classList.remove('hidden');
            
            const newYesBtn = yesBtn.cloneNode(true);
            const newCancelBtn = cancelBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            
            newYesBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
                onConfirm();
            });
            newCancelBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
        };

        // --- HELPERS FOR REVIEWS ---
        // Menghitung rata-rata rating
        const calculateAverageRating = (reviews) => {
            if (!reviews || reviews.length === 0) return 0;
            const sum = reviews.reduce((acc, curr) => acc + parseInt(curr.rating), 0);
            return (sum / reviews.length).toFixed(1);
        };

        // Render bintang statis untuk display (bukan input)
        const renderStarDisplay = (rating) => {
            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            
            for (let i = 0; i < fullStars; i++) {
                stars += '<span class="text-amber-400">★</span>';
            }
            if (hasHalfStar) {
                stars += '<span class="text-amber-400 text-sm">½</span>'; // Simple representation
            }
            for (let i = fullStars + (hasHalfStar ? 1 : 0); i < 5; i++) {
                stars += '<span class="text-gray-300">★</span>';
            }
            return stars;
        };


        // --- ELEMEN DOM ---
        const loginPage = document.getElementById('login-page');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginErrorMessage = document.getElementById('login-error-message');
        const registerErrorMessage = document.getElementById('register-error-message');
        const loginSuccessMessage = document.getElementById('login-success-message');
        const showRegisterLink = document.getElementById('show-register-link');
        const showLoginLink = document.getElementById('show-login-link');
        const logoutBtn = document.getElementById('logout-btn');
        const welcomeMessage = document.getElementById('welcome-message');
        const bookList = document.getElementById('book-list');
        const totalBooksCount = document.getElementById('total-books-count');
        const adminPanel = document.getElementById('admin-panel');
        const superadminPanel = document.getElementById('superadmin-panel');
        const addBookForm = document.getElementById('add-book-form');
        const approvalList = document.getElementById('approval-list');
        const userManagementList = document.getElementById('user-management-list');
        const recentReviewsList = document.getElementById('recent-reviews-list'); // NEW

        // Modal Baca & Review
        const readBookModal = document.getElementById('read-book-modal');
        const closeReadModal = document.getElementById('close-read-modal');
        const closeReadOverlay = document.getElementById('close-read-overlay');
        const readBookTitle = document.getElementById('read-book-title');
        const readBookContent = document.getElementById('read-book-content');
        const modalAvgRating = document.getElementById('modal-avg-rating');
        const reviewForm = document.getElementById('review-form');
        const reviewsListContainer = document.getElementById('reviews-list');
        const reviewCountBadge = document.getElementById('review-count-badge');

        // Modal Edit
        const editBookModal = document.getElementById('edit-book-modal');
        const editBookForm = document.getElementById('edit-book-form');
        const closeEditModal = document.getElementById('close-edit-modal');
        const closeEditOverlay = document.getElementById('close-edit-overlay');

        // --- DATA (State Aplikasi) ---
        let users = {
            denian: { password: 'prasetya', role: 'superadmin' },
            admin123: { password: 'admin123', role: 'admin' },
            user123: { password: 'user123', role: 'user', borrowedBooks: [] }
        };

        let pendingRegistrations = [];

        let books = [
            { 
                id: 1, 
                title: "Laskar Pelangi", 
                author: "Andrea Hirata", 
                cover: "https://upload.wikimedia.org/wikipedia/id/8/8e/Laskar_pelangi_sampul.jpg", 
                borrowedBy: null, 
                content: "Cerita Laskar Pelangi dimulai dari sebuah desa kecil di Belitung...",
                reviews: [
                    { username: 'user123', rating: 5, comment: 'Sangat inspiratif!', date: '2023-10-01' }
                ] 
            },
            { 
                id: 2, 
                title: "Bumi Manusia", 
                author: "Pramoedya A. Toer", 
                cover: "https://upload.wikimedia.org/wikipedia/id/4/49/Bumi_Manusia.jpg", 
                borrowedBy: null, 
                content: "Ini adalah awal dari Tetralogi Buru...",
                reviews: [] 
            },
            { 
                id: 3, 
                title: "Cantik Itu Luka", 
                author: "Eka Kurniawan", 
                cover: "https://upload.wikimedia.org/wikipedia/id/1/1f/Cantik_Itu_Luka.jpg", 
                borrowedBy: null, 
                content: "Di akhir masa kolonial, seorang perempuan...",
                reviews: [] 
            },
            { 
                id: 4, 
                title: "Pulang", 
                author: "Tere Liye", 
                cover: "https://upload.wikimedia.org/wikipedia/id/b/b2/Pulang_-_Tere_Liye.jpg", 
                borrowedBy: null, 
                content: "Sebuah kisah tentang perjalanan pulang...",
                reviews: [] 
            },
            { 
                id: 5, 
                title: "Negeri 5 Menara", 
                author: "Ahmad Fuadi", 
                cover: "https://upload.wikimedia.org/wikipedia/id/2/28/Negeri_5_Menara.jpg", 
                borrowedBy: null, 
                content: "Man Jadda Wajada...",
                reviews: [] 
            },
            { 
                id: 6, 
                title: "Sapiens", 
                author: "Yuval Noah Harari", 
                cover: "https://upload.wikimedia.org/wikipedia/id/5/52/Sapiens_A_Brief_History_of_Humankind.jpg", 
                borrowedBy: null, 
                content: "Sejarah singkat umat manusia...",
                reviews: [
                    { username: 'denian', rating: 4, comment: 'Buku yang membuka wawasan, tapi agak berat.', date: '2023-10-05' }
                ] 
            },
            { 
                id: 7, 
                title: "Atomic Habits", 
                author: "James Clear", 
                cover: "https://images-na.ssl-images-amazon.com/images/I/91bYsX41DVL.jpg", 
                borrowedBy: 'user123', 
                content: "Perubahan kecil yang memberikan hasil luar biasa...",
                reviews: [] 
            }
        ];
        
        if(users.user123) {
            users.user123.borrowedBooks = books.filter(b => b.borrowedBy === 'user123').map(b => b.id);
        }

        let currentUser = null;

        // --- FUNGSI ---

        const showPage = (pageId) => {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
                page.classList.remove('fade-in');
            });
            const target = document.getElementById(pageId);
            if(target) {
                target.classList.remove('hidden');
                target.classList.add('fade-in');
            }
        };

        const renderBooks = () => {
            bookList.innerHTML = '';
            totalBooksCount.textContent = books.length;
            
            books.forEach(book => {
                const isBorrowed = book.borrowedBy !== null;
                const isBorrowedByCurrentUser = currentUser && book.borrowedBy === currentUser.username;
                
                // Calculate Rating
                const avgRating = calculateAverageRating(book.reviews);
                const reviewCount = book.reviews ? book.reviews.length : 0;

                const bookCard = document.createElement('div');
                const opacityClass = (isBorrowed && !isBorrowedByCurrentUser) ? 'opacity-70 grayscale-[0.8]' : 'opacity-100';
                
                bookCard.className = `book-card bg-white shadow-lg rounded-xl overflow-hidden group flex flex-col justify-between relative ${opacityClass}`;
                
                let adminButtons = '';
                let userButtons = '';
                let commonButtons = '';
                let statusLabel = '';

                if (currentUser) {
                    const isAdmin = currentUser.role === 'admin' || currentUser.role === 'superadmin';

                    if (isAdmin) {
                        adminButtons = `
                            <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-20">
                                <button data-id="${book.id}" class="edit-btn bg-blue-500 text-white rounded-full p-2 shadow-lg hover:bg-blue-600 hover:scale-110 transition" title="Edit">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                </button>
                                <button data-id="${book.id}" class="delete-btn bg-red-500 text-white rounded-full p-2 shadow-lg hover:bg-red-600 hover:scale-110 transition" title="Hapus">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>`;
                    } else if (currentUser.role === 'user') {
                        if (isBorrowedByCurrentUser) {
                            userButtons = `<button data-id="${book.id}" class="return-btn w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2.5 px-4 transition-colors">Kembalikan</button>`;
                        } else if (!isBorrowed) {
                            userButtons = `<button data-id="${book.id}" class="borrow-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 transition-colors">Pinjam</button>`;
                        } else {
                             userButtons = `<button disabled class="w-full bg-gray-200 text-gray-400 font-bold py-2.5 px-4 cursor-not-allowed border-t">Tidak Tersedia</button>`;
                        }
                    }
                    
                    commonButtons = `<button data-id="${book.id}" class="read-btn w-full bg-gray-800 hover:bg-gray-900 text-white font-medium py-2.5 px-4 transition-colors border-t border-gray-700">Detail & Ulasan</button>`;
                }
                
                if(isBorrowed) {
                    const badgeColor = isBorrowedByCurrentUser ? 'bg-green-500' : 'bg-rose-500';
                    const badgeText = isBorrowedByCurrentUser ? 'Dipinjam Anda' : `Dipinjam ${book.borrowedBy}`;
                    statusLabel = `<div class="absolute top-3 left-3 ${badgeColor} text-white text-[10px] uppercase tracking-wider font-bold px-2.5 py-1 rounded-md shadow-md z-10 ring-1 ring-white/50">${badgeText}</div>`
                }

                // Render Stars for Card
                const starHTML = avgRating > 0 ? `
                    <div class="flex items-center gap-1 mb-2">
                        <span class="text-amber-400 text-sm">★</span>
                        <span class="text-xs font-bold text-gray-600">${avgRating} (${reviewCount})</span>
                    </div>
                ` : `<div class="text-xs text-gray-400 mb-2 italic">Belum ada rating</div>`;

                bookCard.innerHTML = `
                    <div class="relative h-64 overflow-hidden bg-gray-200 group-hover:shadow-inner">
                        ${statusLabel}
                        ${adminButtons}
                        <img src="${book.cover}" alt="Cover ${book.title}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" onerror="this.onerror=null;this.src='https://placehold.co/400x600/e2e8f0/475569?text=No+Cover';">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                    </div>
                    <div class="p-4 flex-1 flex flex-col relative bg-white">
                        <h3 class="font-bold text-gray-800 text-lg leading-tight mb-1 truncate font-serif" title="${book.title}">${book.title}</h3>
                        <p class="text-indigo-600 text-xs font-bold uppercase tracking-wide mb-1">${book.author}</p>
                        ${starHTML}
                    </div>
                    <div class="mt-auto">
                        ${userButtons}
                        ${commonButtons}
                    </div>
                `;
                bookList.appendChild(bookCard);
            });

            document.querySelectorAll('.delete-btn').forEach(button => button.addEventListener('click', handleDeleteBook));
            document.querySelectorAll('.borrow-btn').forEach(button => button.addEventListener('click', handleBorrowBook));
            document.querySelectorAll('.return-btn').forEach(button => button.addEventListener('click', handleReturnBook));
            document.querySelectorAll('.read-btn').forEach(button => button.addEventListener('click', handleShowReadModal));
            document.querySelectorAll('.edit-btn').forEach(button => button.addEventListener('click', handleShowEditModal));
        };

        // --- FUNGSI BARU UNTUK ADMIN PANEL REVIEWS ---
        const renderRecentReviewsLog = () => {
            recentReviewsList.innerHTML = '';
            
            // Kumpulkan semua review dari semua buku
            let allReviews = [];
            books.forEach(book => {
                if(book.reviews && book.reviews.length > 0) {
                    book.reviews.forEach((rev, index) => {
                        allReviews.push({
                            ...rev,
                            bookTitle: book.title,
                            bookId: book.id,
                            reviewIndex: index
                        });
                    });
                }
            });

            // Sort by date (terbaru di atas) - simulasi sederhana, kita balik arraynya
            allReviews.reverse();

            if(allReviews.length === 0) {
                 recentReviewsList.innerHTML = `<p class="text-gray-400 text-sm italic col-span-full text-center py-4">Belum ada ulasan masuk.</p>`;
                 return;
            }

            allReviews.forEach(rev => {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-3 rounded-lg border border-gray-200 flex flex-col gap-2';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-gray-700 text-sm truncate w-2/3" title="${rev.bookTitle}">${rev.bookTitle}</h4>
                        <span class="text-xs text-gray-400">${rev.date}</span>
                    </div>
                    <div class="flex items-center gap-1 text-xs">
                        <span class="font-semibold text-indigo-600">@${rev.username}</span>
                        <span class="text-amber-400 ml-1">★ ${rev.rating}</span>
                    </div>
                    <p class="text-gray-600 text-xs italic line-clamp-2">"${rev.comment}"</p>
                    <button class="delete-review-admin-btn text-xs text-red-500 hover:text-red-700 text-right mt-auto font-bold" data-book-id="${rev.bookId}" data-index="${rev.reviewIndex}">Hapus Ulasan</button>
                `;
                recentReviewsList.appendChild(card);
            });

            document.querySelectorAll('.delete-review-admin-btn').forEach(btn => btn.addEventListener('click', handleDeleteReviewByAdmin));
        };

        const renderApprovalList = () => {
            approvalList.innerHTML = '';
            document.getElementById('approval-count').textContent = pendingRegistrations.length;

            if (pendingRegistrations.length === 0) {
                approvalList.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-32 text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mb-2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm">Tidak ada permintaan baru.</p>
                    </div>`;
                return;
            }
            pendingRegistrations.forEach(req => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100 hover:bg-indigo-50 transition';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-100 p-2 rounded-full text-indigo-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        </div>
                        <span class="font-medium text-gray-700">${req.username}</span>
                    </div>
                    <div class="flex gap-2">
                        <button data-username="${req.username}" class="approve-btn bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition">Setuju</button>
                        <button data-username="${req.username}" class="reject-btn bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1.5 px-3 rounded shadow transition">Tolak</button>
                    </div>
                `;
                approvalList.appendChild(item);
            });
            document.querySelectorAll('.approve-btn').forEach(btn => btn.addEventListener('click', handleApproveRequest));
            document.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', handleRejectRequest));
        };

        const renderUserManagementList = () => {
            userManagementList.innerHTML = '';
            if (!currentUser || currentUser.role !== 'superadmin') return;

            const allUsers = Object.keys(users).filter(u => u !== currentUser.username);

            if(allUsers.length === 0){
                 userManagementList.innerHTML = `<p class="text-center text-gray-400 text-sm mt-10">Belum ada user lain.</p>`;
                 return;
            }

            allUsers.forEach(username => {
                const user = users[username];
                const item = document.createElement('div');
                item.className = 'flex flex-wrap justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100 hover:bg-gray-100 transition gap-2';
                
                let actionButtons = '';
                if (user.role === 'user') {
                    actionButtons = `<button data-username="${username}" class="promote-btn bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-bold py-1 px-2 rounded mr-1 shadow" title="Jadikan Admin">↑ Admin</button>`;
                } else if (user.role === 'admin') {
                    actionButtons = `<button data-username="${username}" class="demote-btn bg-amber-500 hover:bg-amber-600 text-white text-xs font-bold py-1 px-2 rounded mr-1 shadow" title="Jadikan User">↓ User</button>`;
                }
                
                actionButtons += `<button data-username="${username}" class="delete-user-btn bg-red-100 hover:bg-red-200 text-red-600 text-xs font-bold py-1 px-2 rounded border border-red-200" title="Hapus User">Hapus</button>`;

                item.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-700 text-sm">${username}</p>
                        <p class="text-xs text-gray-500 capitalize flex items-center gap-1 mt-0.5">
                            <span class="w-2 h-2 rounded-full ${user.role === 'admin' ? 'bg-indigo-500' : 'bg-gray-400'}"></span>
                            ${user.role}
                        </p>
                    </div>
                    <div class="flex items-center">
                        ${actionButtons}
                    </div>
                `;
                userManagementList.appendChild(item);
            });

            document.querySelectorAll('.promote-btn').forEach(btn => btn.addEventListener('click', handlePromoteUser));
            document.querySelectorAll('.demote-btn').forEach(btn => btn.addEventListener('click', handleDemoteUser));
            document.querySelectorAll('.delete-user-btn').forEach(btn => btn.addEventListener('click', handleDeleteUser));
        };
        
        const handleLogin = (e) => {
            e.preventDefault();
            const username = loginForm.username.value;
            const password = loginForm.password.value;
            const user = users[username];
            
            if (user && user.password === password) {
                currentUser = { username, role: user.role };
                showPage('library-page');
                
                const roleName = currentUser.role === 'superadmin' ? 'Super Admin' : currentUser.role === 'admin' ? 'Administrator' : 'Member';
                welcomeMessage.textContent = `${roleName}: ${currentUser.username}`;
                
                adminPanel.classList.add('hidden');
                superadminPanel.classList.add('hidden');

                if (currentUser.role === 'admin' || currentUser.role === 'superadmin') {
                    adminPanel.classList.remove('hidden');
                    renderRecentReviewsLog(); // Render log ulasan
                }
                
                if (currentUser.role === 'superadmin') {
                    superadminPanel.classList.remove('hidden');
                    renderApprovalList();
                    renderUserManagementList();
                }
                
                renderBooks();
                loginErrorMessage.classList.add('hidden');
                loginSuccessMessage.classList.add('hidden');
                loginForm.reset();
                showToast(`Selamat datang kembali, ${username}!`);
            } else {
                loginErrorMessage.classList.remove('hidden');
                loginErrorMessage.classList.add('animate-pulse');
                setTimeout(() => loginErrorMessage.classList.remove('animate-pulse'), 500);
                showToast('Gagal login. Periksa username/password', 'error');
            }
        };
        
        const handleLogout = () => {
            customConfirm('Apakah Anda yakin ingin keluar?', () => {
                currentUser = null;
                showPage('login-page');
                adminPanel.classList.add('hidden');
                superadminPanel.classList.add('hidden');
                showToast('Anda telah logout.');
            });
        };

        const handleRegister = (e) => {
            e.preventDefault();
            const username = registerForm['reg-username'].value;
            const password = registerForm['reg-password'].value;
            registerErrorMessage.classList.add('hidden');

            if (users[username] || pendingRegistrations.some(r => r.username === username)) {
                registerErrorMessage.textContent = 'Username sudah digunakan atau sedang menunggu persetujuan.';
                registerErrorMessage.classList.remove('hidden');
                return;
            }

            pendingRegistrations.push({ username, password });
            registerForm.reset();
            showPage('login-page');
            loginSuccessMessage.classList.remove('hidden');
            showToast('Registrasi berhasil dikirim!');
        };

        const handleAddBook = (e) => {
            e.preventDefault();
            const title = document.getElementById('new-book-title').value;
            const author = document.getElementById('new-book-author').value;
            const cover = document.getElementById('new-book-cover').value;
            const content = document.getElementById('new-book-content').value;
            books.push({ id: Date.now(), title, author, cover, content, borrowedBy: null, reviews: [] });
            renderBooks();
            addBookForm.reset();
            showToast('Buku berhasil ditambahkan!', 'success');
        };

        const handleDeleteBook = (e) => {
            const bookId = parseInt(e.currentTarget.closest('.delete-btn').dataset.id);
            customConfirm('Hapus buku ini dari koleksi secara permanen?', () => {
                books = books.filter(book => book.id !== bookId);
                renderBooks();
                showToast('Buku telah dihapus.', 'success');
            });
        };
        
        const handleBorrowBook = (e) => {
            const bookId = parseInt(e.currentTarget.dataset.id);
            const book = books.find(b => b.id === bookId);
            if(book && !book.borrowedBy && currentUser) {
                book.borrowedBy = currentUser.username;
                if(!users[currentUser.username].borrowedBooks) users[currentUser.username].borrowedBooks = [];
                users[currentUser.username].borrowedBooks.push(bookId);
                renderBooks();
                showToast(`Anda berhasil meminjam "${book.title}"`);
            }
        };

        const handleReturnBook = (e) => {
            const bookId = parseInt(e.currentTarget.dataset.id);
            const book = books.find(b => b.id === bookId);
            if(book && currentUser && book.borrowedBy === currentUser.username) {
                book.borrowedBy = null;
                users[currentUser.username].borrowedBooks = users[currentUser.username].borrowedBooks.filter(id => id !== bookId);
                renderBooks();
                showToast(`"${book.title}" berhasil dikembalikan.`);
            }
        };

        // --- LOGIC APPROVAL ---
        const handleApproveRequest = (e) => {
            const username = e.target.dataset.username;
            const request = pendingRegistrations.find(r => r.username === username);
            if (request) {
                users[request.username] = { password: request.password, role: 'user', borrowedBooks: [] };
                pendingRegistrations = pendingRegistrations.filter(r => r.username !== username);
                renderApprovalList();
                renderUserManagementList();
                showToast(`User ${username} telah disetujui.`, 'success');
            }
        };

        const handleRejectRequest = (e) => {
            const username = e.target.dataset.username;
            customConfirm(`Tolak pendaftaran ${username}?`, () => {
                pendingRegistrations = pendingRegistrations.filter(r => r.username !== username);
                renderApprovalList();
                showToast('Permintaan ditolak.', 'error');
            });
        };

        // --- LOGIC SUPER ADMIN ---
        const handlePromoteUser = (e) => {
            const username = e.currentTarget.dataset.username;
            if (users[username]) {
                users[username].role = 'admin';
                renderUserManagementList();
                renderBooks(); 
                showToast(`${username} kini menjadi Admin.`);
            }
        };

        const handleDemoteUser = (e) => {
            const username = e.currentTarget.dataset.username;
            if (users[username]) {
                users[username].role = 'user';
                renderUserManagementList();
                renderBooks();
                showToast(`${username} kini menjadi User biasa.`);
            }
        };

        const handleDeleteUser = (e) => {
            const username = e.currentTarget.dataset.username;
            customConfirm(`Hapus user "${username}" beserta datanya?`, () => {
                if (users[username]) {
                    books.forEach(book => {
                        if (book.borrowedBy === username) {
                            book.borrowedBy = null;
                        }
                    });
                    delete users[username];
                    renderUserManagementList();
                    renderBooks(); 
                    showToast(`User ${username} dihapus.`, 'success');
                }
            });
        };

        // --- LOGIC REVIEW & READ MODAL ---
        const renderReviewsInModal = (book) => {
            reviewsListContainer.innerHTML = '';
            const reviews = book.reviews || [];
            reviewCountBadge.textContent = reviews.length;

            if (reviews.length === 0) {
                reviewsListContainer.innerHTML = `<p class="text-center text-gray-400 text-sm italic mt-4">Belum ada ulasan. Jadilah yang pertama!</p>`;
                return;
            }

            reviews.forEach((review, index) => {
                const reviewEl = document.createElement('div');
                reviewEl.className = 'border-b border-gray-100 pb-3 last:border-0';
                
                // Delete button for Admins
                let deleteBtn = '';
                if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'superadmin')) {
                    deleteBtn = `<button class="delete-review-btn text-red-400 hover:text-red-600 text-xs ml-2" data-book-id="${book.id}" data-review-index="${index}">[Hapus]</button>`;
                }

                reviewEl.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-700 text-sm">${review.username}</span>
                            <span class="text-xs text-gray-400">${review.date}</span>
                        </div>
                        <div>
                            ${renderStarDisplay(review.rating)}
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm leading-snug">
                        ${review.comment}
                        ${deleteBtn}
                    </p>
                `;
                reviewsListContainer.appendChild(reviewEl);
            });

            document.querySelectorAll('.delete-review-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const bookId = parseInt(e.target.dataset.bookId);
                const revIndex = parseInt(e.target.dataset.reviewIndex);
                handleDeleteReview(bookId, revIndex);
            }));
        };

        const handleShowReadModal = (e) => {
            const bookId = parseInt(e.currentTarget.dataset.id);
            const book = books.find(b => b.id === bookId);
            if (book) {
                readBookTitle.textContent = book.title;
                
                // Update avg rating in header
                const avg = calculateAverageRating(book.reviews);
                modalAvgRating.innerHTML = `${renderStarDisplay(avg)} <span class="ml-1 text-gray-600">(${book.reviews ? book.reviews.length : 0})</span>`;

                // Content
                const contentHTML = book.content.split('\n').map(para => `<p class="mb-4">${para}</p>`).join('');
                readBookContent.innerHTML = contentHTML;
                
                // Setup Review Form
                if (currentUser) {
                    document.getElementById('add-review-section').classList.remove('hidden');
                    document.getElementById('review-book-id').value = book.id;
                } else {
                    document.getElementById('add-review-section').classList.add('hidden');
                }

                renderReviewsInModal(book);
                readBookModal.classList.remove('hidden');
            }
        };

        const handleSubmitReview = (e) => {
            e.preventDefault();
            const bookId = parseInt(document.getElementById('review-book-id').value);
            const comment = document.getElementById('review-comment').value;
            const ratingInput = document.querySelector('input[name="rating"]:checked');
            
            if (!ratingInput) {
                showToast('Silakan pilih rating bintang.', 'error');
                return;
            }
            
            const rating = parseInt(ratingInput.value);
            const book = books.find(b => b.id === bookId);

            if (book) {
                if (!book.reviews) book.reviews = [];
                
                const newReview = {
                    username: currentUser.username,
                    rating: rating,
                    comment: comment,
                    date: new Date().toLocaleDateString('id-ID')
                };

                book.reviews.push(newReview);
                
                // Reset Form
                reviewForm.reset();
                
                // Re-render
                renderReviewsInModal(book);
                const avg = calculateAverageRating(book.reviews);
                modalAvgRating.innerHTML = `${renderStarDisplay(avg)} <span class="ml-1 text-gray-600">(${book.reviews.length})</span>`;
                
                // Refresh book list (for average rating update on card) & Admin panel
                renderBooks();
                if(currentUser.role === 'admin' || currentUser.role === 'superadmin') renderRecentReviewsLog();
                
                showToast('Ulasan berhasil dikirim!');
            }
        };

        const handleDeleteReview = (bookId, reviewIndex) => {
            customConfirm('Hapus ulasan ini?', () => {
                const book = books.find(b => b.id === bookId);
                if (book && book.reviews) {
                    book.reviews.splice(reviewIndex, 1);
                    renderReviewsInModal(book); // Update modal UI
                    renderBooks(); // Update card UI
                    if(currentUser.role === 'admin' || currentUser.role === 'superadmin') renderRecentReviewsLog();
                    showToast('Ulasan dihapus.', 'success');
                    
                    // Update header rating
                    const avg = calculateAverageRating(book.reviews);
                    modalAvgRating.innerHTML = `${renderStarDisplay(avg)} <span class="ml-1 text-gray-600">(${book.reviews.length})</span>`;
                }
            });
        };
        
        const handleDeleteReviewByAdmin = (e) => {
            const bookId = parseInt(e.target.dataset.bookId);
            const index = parseInt(e.target.dataset.index);
            // Kita cari index aslinya di array reviews buku tersebut (karena di log admin mungkin urutannya beda/difilter)
            // Namun di implementasi simple ini, kita ambil langsung data dari buku
            handleDeleteReview(bookId, index);
        };

        const handleShowEditModal = (e) => {
            const bookId = parseInt(e.currentTarget.closest('.edit-btn').dataset.id);
            const book = books.find(b => b.id === bookId);
            if (book) {
                document.getElementById('edit-book-id').value = book.id;
                document.getElementById('edit-book-title').value = book.title;
                document.getElementById('edit-book-author').value = book.author;
                document.getElementById('edit-book-cover').value = book.cover;
                document.getElementById('edit-book-content').value = book.content;
                editBookModal.classList.remove('hidden');
            }
        };

        const handleSaveEdit = (e) => {
            e.preventDefault();
            const bookId = parseInt(document.getElementById('edit-book-id').value);
            const book = books.find(b => b.id === bookId);
            if (book) {
                book.title = document.getElementById('edit-book-title').value;
                book.author = document.getElementById('edit-book-author').value;
                book.cover = document.getElementById('edit-book-cover').value;
                book.content = document.getElementById('edit-book-content').value;
                renderBooks();
                editBookModal.classList.add('hidden');
                showToast('Data buku berhasil diperbarui.', 'success');
            }
        };

        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        logoutBtn.addEventListener('click', handleLogout);
        addBookForm.addEventListener('submit', handleAddBook);
        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showPage('register-page'); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showPage('login-page'); });
        reviewForm.addEventListener('submit', handleSubmitReview); // Review Listener

        // Listener Modal Close
        closeReadModal.addEventListener('click', () => readBookModal.classList.add('hidden'));
        closeReadOverlay.addEventListener('click', () => readBookModal.classList.add('hidden'));
        
        closeEditModal.addEventListener('click', () => editBookModal.classList.add('hidden'));
        closeEditOverlay.addEventListener('click', () => editBookModal.classList.add('hidden'));
        editBookForm.addEventListener('submit', handleSaveEdit);

        // --- Inisialisasi Aplikasi ---
        showPage('login-page');
    });
    </script>
</body>
</html>
